<!DOCTYPE html>
<html>
<head>
    <title>Camera Test</title>
</head>
<body>
    <video id="videoElement" autoplay muted></video>
    <button onclick="startCamera()">Start Camera</button>
    <button onclick="capture()">Capture</button>
    <img id="camera" src="" alt="Captured Image">
    <div id="result"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        const videoElement = document.getElementById('videoElement');
        let mediaStream = null;

        function startCamera() {
            navigator.mediaDevices.getUserMedia({ video: true }).then(gotMedia).catch(error =>
                console.error('getUserMedia() error:', error));
        }

        function gotMedia(stream) {
            mediaStream = stream;
            videoElement.srcObject = mediaStream;
            videoElement.addEventListener('loadedmetadata', function() {
                videoElement.play();
            });
        }

        function capture() {
            const canvasElement = document.createElement('canvas');
            const context = canvasElement.getContext('2d');
            canvasElement.width = videoElement.videoWidth;
            canvasElement.height = videoElement.videoHeight;

            context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
            const imageData = canvasElement.toDataURL('image/png');

            img = document.getElementById("camera");
            img.src = imageData;

            // Pause the video and display the current frame as an image
            videoElement.pause();
            videoElement.style.display = 'none';
            img.style.display = 'block';
            img.src = imageData;

            var fd = new FormData();
            fd.append('file', dataURItoBlob(imageData), 'screenshot.png');

            $.ajax({
                type: 'POST',
                url: '/upload',
                data: fd,
                processData: false,
                contentType: false
            }).done(function (data) {
                $('#result').text(data);
                console.log(data);
            });
        }

        function dataURItoBlob(dataURI) {
            const byteString = atob(dataURI.split(',')[1]);
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);
            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }
            return new Blob([ab], { type: 'image/png' });
        }
    </script>
</body>
</html>
